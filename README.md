# Leaderboard Rewards - Solana Reward Distribution System

A Solana Anchor program that automatically distributes custom SPL token rewards to GitHub contributors based on their XP from a leaderboard. The system updates daily and distributes rewards weekly.

## 🎯 Features

- **Proportional Rewards**: Contributors receive tokens proportional to their XP share
- **Daily Updates**: Oracle bot automatically updates contributor XP on-chain
- **Weekly Epochs**: Reward distribution periods with automatic finalization
- **Custom SPL Token**: Creates and manages custom reward token
- **Dual Authority**: Separate admin and oracle roles for security
- **Comprehensive Tests**: Full test coverage for all instructions
- **Easy Deployment**: Scripts for initialization and management

## 📋 Architecture

### On-Chain Components

- **Config Account**: Global program configuration (admin, oracle, reward token)
- **Reward Epoch**: Weekly distribution periods with reward pools
- **Contributor Accounts**: GitHub username → wallet mappings
- **XP Snapshots**: Per-epoch XP records for each contributor

### Off-Chain Components

- **Oracle Bot**: Automated service that updates XP and manages epochs
- **Deployment Scripts**: Initialize program, fund pools, create epochs
- **Tests**: Comprehensive test suite

## 🚀 Quick Start

### Prerequisites

```bash
# Install Solana CLI
sh -c "$(curl -sSfL https://release.solana.com/stable/install)"

# Install Anchor
cargo install --git https://github.com/coral-xyz/anchor --tag v0.31.1 anchor-cli --locked

# Install Node dependencies
yarn install
cd oracle-bot && pnpm install
```

### 1. Build and Deploy

```bash
# Build the program
anchor build

# Sync program ID
anchor keys sync

# Deploy to devnet
yarn deploy:devnet
```

### 2. Initialize Program

```bash
# Initialize on devnet (creates config, reward token, oracle)
yarn init:devnet

# This will:
# - Create program config account
# - Create custom SPL token for rewards
# - Set up admin and oracle authorities
# - Generate oracle bot configuration file
```

### 3. Fund Reward Pool

```bash
# Mint and fund reward pool with tokens
yarn fund 1000000000000000

# Amount in smallest units (9 decimals)
# 1000000000000000 = 1,000,000 tokens
```

### 4. Create First Epoch

```bash
# Create first weekly epoch
yarn create-epoch 100000000000000

# Amount is the total reward pool for this epoch
# 100000000000000 = 100,000 tokens
```

### 5. Start Oracle Bot

```bash
cd oracle-bot

# Configure .env (auto-generated by init script)
# Edit if needed for custom leaderboard API

# Start bot (daily + weekly tasks)
pnpm start

# Or run manual updates
pnpm run update-daily   # Update XP once
pnpm run update-weekly  # Finalize epoch and create new one
```

## 📖 Usage Guide

### For Contributors

1. **Register**: Link GitHub username to wallet
```typescript
await program.methods
  .registerContributor("github_username")
  .accounts({ ... })
  .rpc();
```

2. **Earn XP**: Contribute to the project (tracked off-chain)

3. **Claim Rewards**: After epoch finalization
```typescript
await program.methods
  .claimRewards(epochNumber)
  .accounts({ ... })
  .rpc();
```

### For Admins

```bash
# Update oracle authority
tsx scripts/update-oracle.ts <new_oracle_pubkey>

# Fund reward pool
yarn fund <amount>

# Check epoch stats
tsx scripts/check-epoch.ts <epoch_number>
```

### For Oracle

The oracle bot runs automatically, but you can trigger manual updates:

```bash
cd oracle-bot

# Daily: Update all contributor XP
pnpm run update-daily

# Weekly: Finalize current epoch and create new one
pnpm run update-weekly
```

## 🧪 Testing

```bash
# Run all tests
anchor test

# Run tests on localnet with logs
anchor test --skip-deploy

# Run specific test
anchor test --skip-deploy -- --grep "Claims rewards"
```

### Test Coverage

- ✅ Program initialization
- ✅ Oracle authority updates
- ✅ Epoch creation
- ✅ Contributor registration
- ✅ XP recording and updates
- ✅ Reward pool funding
- ✅ Epoch finalization
- ✅ Proportional reward claims
- ✅ Double-claim prevention
- ✅ GitHub username updates

## 📂 Project Structure

```
leaderboard-rewards/
├── programs/
│   └── leaderboard-rewards/
│       └── src/
│           └── lib.rs              # Main program logic
├── oracle-bot/
│   ├── src/
│   │   ├── index.ts                # Bot entry point
│   │   ├── client.ts               # Program client
│   │   ├── oracle.ts               # Oracle operations
│   │   ├── leaderboard.ts          # Data fetcher
│   │   ├── logger.ts               # Logging utility
│   │   └── config.ts               # Configuration
│   └── package.json
├── scripts/
│   ├── initialize.ts               # Deploy & init script
│   ├── mint-and-fund.ts            # Fund reward pool
│   ├── create-epoch.ts             # Create new epoch
│   └── utils.ts                    # Utility functions
├── tests/
│   └── leaderboard-rewards.ts          # Comprehensive tests
├── Anchor.toml                     # Anchor configuration
├── package.json                    # Project dependencies
└── SPECS.md                        # Technical specifications
```

## 🔑 Account Structure

### Program Derived Addresses (PDAs)

```rust
// Config: ["config"]
pub struct Config {
    admin: Pubkey,
    oracle: Pubkey,
    reward_mint: Pubkey,
    reward_vault: Pubkey,
    current_epoch: u64,
}

// Epoch: ["epoch", epoch_number]
pub struct RewardEpoch {
    epoch_number: u64,
    start_time: i64,
    end_time: i64,
    total_xp: u64,
    reward_amount: u64,
    contributor_count: u16,
    finalized: bool,
}

// Contributor: ["contributor", wallet]
pub struct Contributor {
    wallet: Pubkey,
    github_username: String,
    total_xp: u64,
    lifetime_rewards: u64,
}

// Snapshot: ["snapshot", epoch_number, wallet]
pub struct EpochSnapshot {
    contributor: Pubkey,
    epoch: u64,
    xp: u64,
    claimed: bool,
}
```

## 💰 Reward Distribution Formula

```
User Reward = (User XP / Total Epoch XP) × Epoch Reward Pool

Example:
- Epoch pool: 100,000 tokens
- Total XP: 1,000,000
- Alice XP: 50,000 (5%)
→ Alice reward: 5,000 tokens
```

## 🔒 Security

- **Authority Separation**: Admin controls config, Oracle only updates data
- **XP Validation**: Max 100,000 XP increase per update
- **Claim Windows**: 30-day window to claim after epoch ends
- **Double-Claim Prevention**: On-chain tracking of claimed rewards
- **PDA Verification**: All accounts verified via seeds

## 🛠 Configuration

### Program Configuration (Anchor.toml)

```toml
[programs.devnet]
leaderboard_rewards = "YOUR_PROGRAM_ID"

[provider]
cluster = "devnet"
wallet = "~/.config/solana/id.json"
```

### Oracle Bot Configuration (oracle-bot/.env)

```env
RPC_URL=https://api.devnet.solana.com
CLUSTER=devnet
PROGRAM_ID=<program_id>
ORACLE_PRIVATE_KEY=<base58_key>

LEADERBOARD_API_URL=https://your-api.com/leaderboard
EPOCH_REWARD_AMOUNT=100000000000000
EPOCH_DURATION_DAYS=7

DAILY_CRON_SCHEDULE=0 0 * * *
WEEKLY_CRON_SCHEDULE=0 0 * * 0
```

## 📊 Monitoring

### Check Current Epoch

```bash
tsx scripts/check-epoch.ts
```

### View Contributor Stats

```bash
tsx scripts/view-contributor.ts <wallet_address>
```

### Oracle Bot Logs

```bash
cd oracle-bot
tail -f oracle-bot.log
```

## 🐛 Troubleshooting

### "Epoch not finalized yet"
Wait for epoch to end (7 days) or oracle bot to finalize it.

### "Already claimed"
Rewards for this epoch were already claimed.

### "XP too high"
Max 100,000 XP increase per update. Contact admin if legitimate.

### Transaction Failed
- Check wallet has sufficient SOL for fees
- Verify RPC endpoint is accessible
- Confirm program is deployed to correct cluster

## 🚢 Deployment Checklist

- [ ] Build and deploy program
- [ ] Run `anchor keys sync`
- [ ] Initialize program (creates config, token, vault)
- [ ] Fund reward vault with tokens
- [ ] Create first epoch
- [ ] Configure oracle bot
- [ ] Test with small epoch first
- [ ] Monitor oracle bot logs
- [ ] Set up monitoring/alerts

## 📝 License

MIT

## 🤝 Contributing

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

## 📞 Support

- GitHub Issues: [Report bugs or request features](https://github.com/Sendo-labs/leaderboard-rewards/issues)
- Documentation: See [SPECS.md](./SPECS.md) for technical details
- Oracle Bot: See [oracle-bot/README.md](./oracle-bot/README.md)

## 🎓 Learn More

- [Anchor Framework](https://www.anchor-lang.com/)
- [Solana Documentation](https://docs.solana.com/)
- [SPL Token Program](https://spl.solana.com/token)
- [Program Derived Addresses](https://solanacookbook.com/core-concepts/pdas.html)

---

Built with ❤️ using Anchor and Solana

