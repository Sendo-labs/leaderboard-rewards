# Deployment Checklist

## Pre-Deployment

### 1. Code Review
- [ ] Review all Solana program changes
- [ ] Review oracle bot updates
- [ ] Review initialization scripts
- [ ] Verify Token-2022 NonTransferable extension usage for SBT tokens
- [ ] Understand dual-token system: USDC (SPL Token) for rewards, SBT (Token-2022 NonTransferable) for reputation

### 2. Dependencies
- [ ] `anchor-lang@0.31.1` installed
- [ ] `anchor-spl@0.31.1` installed
- [ ] `spl-token-2022@6.0` added to Cargo.toml
- [ ] Oracle bot dependencies up to date

### 3. Configuration
- [ ] Program ID updated in `Anchor.toml`
- [ ] Program ID synced with `declare_id!` in `lib.rs`
- [ ] USDC mint addresses configured (devnet/mainnet)
- [ ] Oracle keypair generated and secured

## Build & Test

### 4. Build Program
```bash
cd leaderboard-rewards
anchor build
```
- [ ] Build succeeds without errors
- [ ] Program binary generated in `target/deploy/`
- [ ] IDL generated in `target/idl/`

### 5. Sync Keys
```bash
anchor keys sync
```
- [ ] Program ID matches in all files
- [ ] `Anchor.toml` updated
- [ ] `lib.rs` declare_id! updated

### 6. Local Testing (Optional but Recommended)
```bash
anchor test
```
- [ ] All tests pass (note: some may need updates for new architecture)
- [ ] No critical errors or warnings

## Devnet Deployment

### 7. Deploy to Devnet
```bash
anchor deploy --provider.cluster devnet
```
- [ ] Deployment succeeds
- [ ] Program ID noted: `HHU31ZnG6NrdXYLseioh5hhDwBX1Zwmv2nyrfiC46yHc`
- [ ] Transaction signature saved

### 8. Initialize Program
```bash
yarn init:devnet
```
- [ ] Config PDA created
- [ ] USDC vault created (SPL Token - for weekly rewards)
- [ ] SBT mint initialized (Token-2022 NonTransferable - for reputation tokens)
- [ ] Oracle bot `.env` generated with correct program ID
- [ ] SBT mint keypair saved to `keys/sbt-mint.json`

**Note**: This program uses TWO token systems:
- **USDC** (SPL Token): Weekly rewards distributed proportionally based on XP
- **SBT** (Token-2022 NonTransferable): Soul-bound reputation tokens (1 XP = 100 SBT)

**Expected Output:**
```
âœ… Program initialized successfully!
âœ… Oracle bot configuration saved to oracle-bot/.env
âœ… SBT mint keypair saved to keys/sbt-mint.json

ðŸ“‹ Next Steps:
1. Fund the USDC vault
2. Create first epoch
3. Start oracle bot
```

### 9. Fund USDC Pool
```bash
# Get USDC from devnet faucet first
# Then fund with desired amount
yarn fund 100000000000  # 100,000 USDC (6 decimals)
```
- [ ] USDC balance sufficient
- [ ] Transfer succeeds
- [ ] Vault balance verified

### 10. Create First Epoch
```bash
yarn create-epoch 10000000000  # 10,000 USDC reward pool
```
- [ ] Epoch created successfully
- [ ] Epoch number is 1
- [ ] Start/end time set correctly (7-day duration)
- [ ] Reward amount matches input

### 11. Configure Oracle Bot
```bash
cd oracle-bot
```
- [ ] `.env` file exists (generated by init)
- [ ] Review and adjust settings:
  - [ ] `RPC_URL` correct
  - [ ] `CLUSTER=devnet`
  - [ ] `PROGRAM_ID` matches deployed program
  - [ ] `ORACLE_PRIVATE_KEY` set
  - [ ] `LEADERBOARD_API_URL` points to data source
  - [ ] `EPOCH_REWARD_AMOUNT` appropriate

### 12. Test Oracle Bot
```bash
# Run manual daily update once
pnpm run update-daily
```
- [ ] Connects to program successfully
- [ ] Fetches leaderboard data
- [ ] Syncs contributor XP
- [ ] Reports success/failure counts
- [ ] Logs SBT tokens earned

### 13. Start Oracle Bot
```bash
pnpm start
```
- [ ] Bot starts without errors
- [ ] Daily cron schedule loaded
- [ ] Weekly cron schedule loaded
- [ ] Logs indicate waiting for scheduled tasks

### 14. Test Contributor Claims

**SBT Claim (Soul-Bound Tokens):**
```bash
yarn claim-sbt <wallet_path>
```
- [ ] Displays correct SBT claimable amount (XP Ã— 100)
- [ ] Mints SBT tokens successfully using Token-2022
- [ ] Token account shows balance
- [ ] Transfer disabled (NonTransferable extension verified)
- [ ] Tokens are soul-bound to contributor wallet

**USDC Claim (after epoch finalized):**
```bash
# Wait for epoch to end and oracle to finalize it
# Contributors claim proportional USDC rewards through the program
# Note: Use program instruction directly or integrate claim UI
```
- [ ] Contributor can claim proportional USDC based on their XP share
- [ ] Double-claim prevented by program logic
- [ ] USDC balance updated correctly
- [ ] Claim window enforced (30 days after epoch finalization)

## Leaderboard Integration

### 15. Coordinate with Leaderboard Team
- [ ] Share `LEADERBOARD_INTEGRATION.md` with team
- [ ] Confirm export format requirements understood
- [ ] Set export schedule (daily at 23:00 UTC recommended)
- [ ] Verify export URL accessibility

### 16. Test Export Format
```bash
# Test weekly leaderboard (default/recommended)
curl https://sendo-labs.github.io/leaderboard/data/api/leaderboard-weekly.json | jq .

# Or test other time periods:
# Monthly: https://sendo-labs.github.io/leaderboard/data/api/leaderboard-monthly.json
# Lifetime: https://sendo-labs.github.io/leaderboard/data/api/leaderboard-lifetime.json
```
- [ ] Export accessible from configured URL
- [ ] Format matches specification (see LEADERBOARD_INTEGRATION.md)
- [ ] All required fields present
- [ ] Wallet addresses valid (Solana pubkeys)
- [ ] XP values positive
- [ ] Multi-dimensional XP data structure correct

### 17. Test Integration
- [ ] Oracle bot fetches export successfully
- [ ] Parses multi-dimensional XP correctly
- [ ] Syncs all contributors without errors
- [ ] SBT calculations accurate (xp Ã— 100)

## Monitoring

### 18. Setup Monitoring
- [ ] Oracle bot logs to file
- [ ] Log rotation configured (if needed)
- [ ] Error alerting setup (optional)
- [ ] Daily sync success tracked
- [ ] Weekly epoch management tracked

### 19. Verify Daily Operations
After 24 hours:
- [ ] Oracle ran daily update at scheduled time
- [ ] All contributors synced successfully
- [ ] XP updated on-chain
- [ ] SBT claimable amounts increased
- [ ] No critical errors in logs

### 20. Verify Weekly Operations
After 7 days:
- [ ] Oracle finalized current epoch
- [ ] Created new epoch
- [ ] Contributors can claim USDC
- [ ] Reward distribution proportional to XP

## Mainnet Preparation

### 21. Mainnet Checklist
- [ ] All devnet testing successful
- [ ] No critical issues or bugs found
- [ ] Security audit completed (recommended)
- [ ] Sufficient SOL for mainnet deployment
- [ ] USDC funding source confirmed
- [ ] Oracle infrastructure production-ready

### 22. Mainnet Deployment
```bash
# Deploy to mainnet
anchor deploy --provider.cluster mainnet

# Initialize with mainnet USDC
yarn init:mainnet

# Fund with real USDC
yarn fund <amount>

# Start production oracle
cd oracle-bot
CLUSTER=mainnet pnpm start
```

### 23. Post-Deployment
- [ ] Announce program address to community
- [ ] Update documentation with mainnet addresses
- [ ] Monitor initial operations closely
- [ ] Prepare contributor guides
- [ ] Setup support channels

## Emergency Procedures

### 24. Rollback Plan
If issues detected:
1. Stop oracle bot immediately
2. Document the issue
3. Pause epoch creation if needed
4. Investigate on devnet
5. Deploy fix
6. Resume operations

### 25. Update Oracle Authority
If oracle compromised:
```bash
tsx scripts/update-oracle.ts <new_oracle_pubkey>
```

## Documentation

### 26. Update Documentation
- [ ] Complete `SPECS.md` with final architecture
- [ ] Update `README.md` with deployment info
- [ ] Update `oracle-bot/README.md` with production config
- [ ] Create contributor guides
- [ ] Update API documentation if needed

## Support

### 27. Community Support
- [ ] Create FAQ document
- [ ] Setup Discord support channel
- [ ] Prepare troubleshooting guide
- [ ] Document common issues and solutions

## Success Criteria

âœ… **Core Functionality:**
- Program deployed and initialized
- Dual-token system operational (USDC for rewards, SBT for reputation)
- USDC vault funded
- Epochs creating/finalizing correctly
- XP syncing from leaderboard
- USDC rewards distributing proportionally based on XP
- SBT tokens (Token-2022 NonTransferable) minting correctly
- Claims working without errors
- SBT tokens non-transferable as expected

âœ… **Oracle Operations:**
- Daily updates running automatically
- Weekly epoch management working
- Error handling functioning
- Logging providing visibility

âœ… **Integration:**
- Leaderboard export in correct format
- Multi-dimensional XP syncing
- Wallet addresses resolving correctly
- No data inconsistencies

âœ… **User Experience:**
- Contributors can register
- Contributors can claim USDC
- Contributors can claim SBT
- Balances updating correctly
- Transactions completing successfully

## Notes

- **Devnet Testing Duration**: Recommend at least 2 full weekly cycles (14 days) before mainnet
- **USDC Funding**: Ensure sustainable funding model from plugin revenue
- **Oracle Uptime**: Critical for daily syncs - consider redundancy
- **Community Communication**: Keep contributors informed throughout process

## Contact

For deployment support:
- GitHub Issues: https://github.com/Sendo-labs/leaderboard-rewards/issues
- Technical Questions: Reference implementation code and documentation
- Integration Support: See `LEADERBOARD_INTEGRATION.md`

